import { promptAction, router } from '@kit.ArkUI';
import MyData from '../../entity/MyData';
import OrderBean from '../../entity/OrderBean';
import DbUtil from '../../utils/DbUtil';
import MyRdb from "../../sqlite/MyRdb";
import { ShopBean } from '../../entity/types';

// Define FoodItem interface
interface FoodItem {
  name: string;
  count: number;
  price: number;
}

// Define DeliveryOrder class instead of interface
class DeliveryOrder {
  orderCode: string;
  status: string;
  shopName: string;
  imgId: number;
  dateAdded: string;
  totalPrice: number;
  orderId: number | null;
  foodList: FoodItem[];
  address: string;
  phone: string;

  constructor() {
    this.orderCode = '';
    this.status = '';
    this.shopName = '';
    this.imgId = 0;
    this.dateAdded = '';
    this.totalPrice = 0;
    this.orderId = null;
    this.foodList = [];
    this.address = '';
    this.phone = '';
  }
}

@Component
export struct HomeTakeout {
  @State deliveryList: DeliveryOrder[] = []
  userType: string = ''

  async aboutToAppear() {
    await MyRdb.getInstance().initRdbStore(getContext(this));
    this.loadDeliveryOrders()
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ  - æ¨¡ä»¿å›¾ç‰‡æ ·å¼
      Row() {

        Text('é…é€è®¢å•')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
      }
      .width('100%')
      .height(56)
      .margin({ top: 17 })
      .justifyContent(FlexAlign.Center)
      .backgroundColor('#F7EEDD')
      .border({
        width: { bottom: 1 },
        color: '#F0F0F0'
      })

      // è®¢å•åˆ—è¡¨å®¹å™¨
      Scroll() {
        Column({ space: 12 }) {
          ForEach(this.deliveryList, (item: DeliveryOrder) => {
            this.DeliveryItem(item)
          })
        }
        .padding({
          left: 16,
          right: 16,
          top: 16,
          bottom: 16
        })
      }
      .scrollBar(BarState.Off)
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F7EEDD')
  }

  private getStatusText(state: number): string {
    switch (state) {
      case 0:
        return 'å¾…å–é¤'
      case 1:
        return 'é…é€ä¸­'
      case 2:
        return 'å·²å®Œæˆ'
      default:
        return 'æœªçŸ¥çŠ¶æ€'
    }
  }


  private getStatusColor(status: string): string {
    switch (status) {
      case 'å¾…å–é¤':
        return '#FF6B35'
      case 'é…é€ä¸­':
        return '#4CAF50'
      case 'å·²å®Œæˆ':
        return '#9E9E9E'
      default:
        return '#FF6B35'
    }
  }

  async updateOrderStatus(orderId: number | null) {
    if (orderId === null) return

    try {
      const orders = await DbUtil.queryOrderList()
      const order = orders.find(o => o.id === orderId)
      if (order) {
        order.state = 1 // æ›´æ–°ä¸ºé…é€ä¸­çŠ¶æ€
        await DbUtil.updateOrder(order)
        await this.loadDeliveryOrders()
      }
    } catch (error) {
      console.error('æ›´æ–°è®¢å•çŠ¶æ€å¤±è´¥', error.message)
    }
  }

  @Builder
  DeliveryItem(item: DeliveryOrder) {
    Column() {
      // è®¢å•çŠ¶æ€æ å’Œç¼–å·
      Row() {
        Row() {
          Text(item.status)
            .fontSize(12)
            .fontColor('#FFFFFF')
            .fontWeight(FontWeight.Medium)
        }
        .height(24)
        .padding({ left: 8, right: 8 })
        .backgroundColor(this.getStatusColor(item.status))
        .borderRadius(12)
        .justifyContent(FlexAlign.Center)

        Blank()

        Text(`è®¢å•ç¼–å·ï¼š${item.orderCode}`)
          .fontSize(13)
          .fontColor('#666666')
      }
      .width('100%')
      .margin({ bottom: 12 })

      // ä¸»è¦å†…å®¹åŒºåŸŸ
      Row() {
        // å•†å“å›¾ç‰‡
        Image(MyData.getShopIconByName(item.shopName))
          .width(60)
          .height(60)
          .borderRadius(8)
          .backgroundColor('#F0F0F0')

        // è®¢å•ä¿¡æ¯
        Column() {
          // å•†å®¶ä¿¡æ¯
          Row() {
            Image($r('app.media.app_icon'))
              .width(16)
              .height(16)
              .fillColor('#FF6B35')
            Text(item.shopName)
              .fontSize(16)
              .fontColor('#333333')
              .fontWeight(FontWeight.Medium)
              .margin({ left: 4 })
          }
          .width('100%')
          .margin({ bottom: 8 })

          // å•†å“ä¿¡æ¯é¢„è§ˆ
          Column() {
            ForEach(item.foodList.slice(0, 2), (food: FoodItem, index: number) => {
              Row() {
                Text(food.name)
                  .fontSize(14)
                  .fontColor('#666666')
                  .layoutWeight(1)
                Text(`x${food.count}`)
                  .fontSize(14)
                  .fontColor('#666666')
                  .margin({ left: 8 })
              }
              .width('100%')
              .margin({ bottom: index === 0 ? 4 : 0 })
            })

            if (item.foodList.length > 2) {
              Text(`...ç­‰${item.foodList.length}ç§å•†å“`)
                .fontSize(12)
                .fontColor('#999999')
                .width('100%')
                .margin({ top: 4 })
            }
          }
          .alignItems(HorizontalAlign.Start)
          .margin({ bottom: 8 })

          // æ—¶é—´ä¿¡æ¯
          Text(`ä¸‹å•æ—¶é—´ï¼š${item.dateAdded}`)
            .fontSize(12)
            .fontColor('#999999')
            .width('100%')
        }
        .layoutWeight(1)
        .margin({ left: 12 })
        .alignItems(HorizontalAlign.Start)
      }
      .width('100%')
      .alignItems(VerticalAlign.Top)

      // åº•éƒ¨ä»·æ ¼åŒºåŸŸ
      Row() {
        Column() {
          Text(`ï¿¥${item.totalPrice.toFixed(2)}`)
            .fontSize(20)
            .fontColor('#FF6B35')
            .fontWeight(FontWeight.Bold)
          Text('è®¢å•é‡‘é¢')
            .fontSize(12)
            .fontColor('#999999')
            .margin({ top: 2 })
        }
        .alignItems(HorizontalAlign.Start)

        Blank()

        if (item.status === 'å¾…å–é¤') {
          Button('æ¥å•', { type: ButtonType.Capsule })
            .width(80)
            .height(36)
            .fontSize(14)
            .fontColor('#FFFFFF')
            .backgroundColor('#FF6B35')
            .onClick(async () => {
              await this.updateOrderStatus(item.orderId)
              promptAction.showToast({
                message: 'æ¥å•æˆåŠŸï¼',
                duration: 2000
              })
            })
        } else if (item.status === 'é…é€ä¸­') {
          Row() {
            Circle({ width: 8, height: 8 })
              .fill('#4CAF50')
              .margin({ right: 6 })
            Text('é…é€ä¸­')
              .fontSize(14)
              .fontColor('#4CAF50')
              .fontWeight(FontWeight.Medium)
          }
        } else {
          Text('å·²å®Œæˆ')
            .fontSize(14)
            .fontColor('#9E9E9E')
            .fontWeight(FontWeight.Medium)
        }
      }

      .width('100%')
      .margin({ top: 12 })
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
    .shadow({
      radius: 8,
      color: '#1A000000',
      offsetX: 0,
      offsetY: 2
    })
    .margin({ bottom: 10 })
    .onClick(() => {
      this.showOrderDetail(item)
    })
  }

  // æ˜¾ç¤ºè®¢å•è¯¦æƒ…
  private showOrderDetail(order: DeliveryOrder) {
    AlertDialog.show({
      title: 'è®¢å•è¯¦æƒ…',
      message: this.buildOrderDetailMessage(order),
      alignment: DialogAlignment.Center,
      primaryButton: {
        value: 'ç¡®å®š',
        fontColor: '#FFFFFF',
        backgroundColor: '#FF6B35',
        action: () => {
          console.info('å…³é—­è®¢å•è¯¦æƒ…')
        }
      },
      secondaryButton: {
        value: 'å–æ¶ˆ',
        fontColor: '#666666',
        backgroundColor: '#F5F5F5',
        action: () => {
          console.info('å–æ¶ˆè®¢å•è¯¦æƒ…')
        }
      }
    })
  }

  // æ„å»ºè®¢å•è¯¦æƒ…æ¶ˆæ¯
  private buildOrderDetailMessage(order: DeliveryOrder): string {
    let message = `ğŸ“‹ è®¢å•ç¼–å·ï¼š${order.orderCode}\n`
    message += `ğŸ“ è®¢å•çŠ¶æ€ï¼š${order.status}\n`
    message += `ğŸª å•†å®¶åç§°ï¼š${order.shopName}\n`
    message += `â° ä¸‹å•æ—¶é—´ï¼š${order.dateAdded}\n`
    message += `ğŸ“ é…é€åœ°å€ï¼š${order.address}\n`
    message += `ğŸ“ è”ç³»ç”µè¯ï¼š${order.phone}\n`
    message += `ğŸ’° è®¢å•é‡‘é¢ï¼šï¿¥${order.totalPrice}\n`
    message += '\nğŸ½ï¸ å•†å“æ¸…å•ï¼š\n'

    order.foodList.forEach((item, index) => {
      message += `${index + 1}. ${item.name} x${item.count} ï¿¥${(item.price * item.count).toFixed(2)}\n`
    })

    return message
  }

  // åŠ è½½é…é€è®¢å•
  async loadDeliveryOrders() {
    try {
      // 1. æŸ¥è¯¢æ‰€æœ‰è®¢å•
      const orders: OrderBean[] = await DbUtil.queryOrderList()

      // 2. ä¸ºæ¯ä¸ªè®¢å•è·å–è¯¦ç»†ä¿¡æ¯
      // 2. ä¸ºæ¯ä¸ªè®¢å•è·å–è¯¦ç»†ä¿¡æ¯
      this.deliveryList = await Promise.all(
        orders
          .sort((a, b) => new Date(b.date_added).getTime() - new Date(a.date_added).getTime()) // å€’åº
          .map(async (order: OrderBean, index: number) => {
            const deliveryOrder = new DeliveryOrder();

            // åŸºç¡€è®¢å•ä¿¡æ¯
            deliveryOrder.orderCode = order.order_code;
            deliveryOrder.status = index === 0 ? 'é…é€ä¸­' : 'å·²å®Œæˆ'; // ğŸ‘ˆ å…³é”®é€»è¾‘
            deliveryOrder.shopName = order.shop_name;
            deliveryOrder.imgId = order.img_id;
            deliveryOrder.dateAdded = order.date_added;
            deliveryOrder.totalPrice = order.total_price;
            deliveryOrder.orderId = order.id;

            // å…¶ä½™ä»£ç ä¸å˜...

          // 3. æ ¹æ®è®¢å•ä¸­çš„ goods_ids æŸ¥è¯¢èœå“è¯¦æƒ…
          try {
            if (order.goods_ids) {
              const goodsIds = this.parseGoodsIds(order.goods_ids);

              // 1. ä½¿ç”¨Mapç»Ÿè®¡æ¯ä¸ªå•†å“IDçš„å‡ºç°æ¬¡æ•°
              const idCountMap = new Map<string, number>();
              goodsIds.forEach(id => {
                idCountMap.set(id, (idCountMap.get(id) || 0) + 1);
              });

              // 2. è·å–å”¯ä¸€IDåˆ—è¡¨
              const uniqueIds = Array.from(idCountMap.keys());

              // 3. æ‰¹é‡æŸ¥è¯¢å•†å“ä¿¡æ¯ï¼ˆä¿æŒåŸæœ‰çš„ä¸²è¡ŒæŸ¥è¯¢æ–¹å¼ï¼Œé¿å…å¹¶è¡Œå‹åŠ›ï¼‰
              const foodList: FoodItem[] = [];
              for (const id of uniqueIds) {
                const food = await MyRdb.getInstance().getFoodById(getContext(this), id);
                if (food) {
                  foodList.push({
                    name: food.name,
                    count: idCountMap.get(id) || 1, // ä½¿ç”¨ç»Ÿè®¡çš„æ•°é‡
                    price: food.price
                  });
                }
              }

              deliveryOrder.foodList = foodList;
            } else {
              deliveryOrder.foodList = [];
            }
          } catch (error) {
            console.error('æŸ¥è¯¢èœå“è¯¦æƒ…å¤±è´¥:', error);
            deliveryOrder.foodList = [];
          }

          // 4. è®¾ç½®é…é€åœ°å€å’Œç”µè¯
          deliveryOrder.address = 'å­¦æºè¡—ä¸­å›½è®¡é‡å¤§å­¦258å·';
          deliveryOrder.phone = '15906635646';

          return deliveryOrder;
        })
      );

      // åˆ†ç¦»å½“å‰è®¢å•å’Œå†å²è®¢å•


      console.log('ä¸ªäººé¡µé¢è®¢å•åŠ è½½å®Œæˆ:', this.deliveryList);
    } catch (error) {
      console.error('åŠ è½½è®¢å•å¤±è´¥', error.message);
      this.deliveryList = [];

    }
  }

  // è¾…åŠ©æ–¹æ³•ï¼šè§£æå•†å“IDå­—ç¬¦ä¸²
  private parseGoodsIds(goodsIds: string): string[] {
    try {
      if (goodsIds.startsWith('[') || goodsIds.startsWith('{')) {
        return JSON.parse(goodsIds);
      } else if (goodsIds.includes(',')) {
        return goodsIds.split(',').map(id => id.trim());
      } else {
        return [goodsIds];
      }
    } catch (error) {
      console.error('è§£æå•†å“IDå¤±è´¥:', error);
      return [];
    }
  }
}