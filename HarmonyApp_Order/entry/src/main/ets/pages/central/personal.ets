import User from "../../entity/User"
import { AppStorageV2, promptAction, router } from '@kit.ArkUI';
import MyData from '../../entity/MyData';
import OrderBean from '../../entity/OrderBean';
import DbUtil from '../../utils/DbUtil';
import { ShopBean } from '../../entity/types';
import MyRdb from "../../sqlite/MyRdb";
import Food from "../../entity/Food";
import { UserInfo, UserInfoWithPassword } from '../../common/UserInfo';
import { GlobalStorage } from "../../entity/GlobalStorage";


// Define FoodItem interface
interface FoodItem {
  name: string;
  count: number;
  price: number;
}

// Define DeliveryOrder class
class DeliveryOrder {
  orderCode: string;
  status: string;
  shopName: string;
  imgId: number;
  dateAdded: string;
  totalPrice: number;
  orderId: number | null;
  foodList: FoodItem[];
  address: string;
  phone: string;

  constructor() {
    this.orderCode = '';
    this.status = '';
    this.shopName = '';
    this.imgId = 0;
    this.dateAdded = '';
    this.totalPrice = 0;
    this.orderId = null;
    this.foodList = [];
    this.address = '';
    this.phone = '';
  }
}

@CustomDialog
struct UserEditDialog {
  @State pathStack: NavPathStack = AppStorageV2.connect(NavPathStack, "navStack", () => new NavPathStack())!
  @State userInfo: UserInfoWithPassword = {
    user_id: 0,
    username: '',
    password: '',
    phone: '',
    avatar_url: '',
    campus_id: 0,
    balance: 0
  }
  controller: CustomDialogController
  onConfirm: (user: UserInfoWithPassword) => void = () => {
  }
  path: () => void = () => {
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text('ç¼–è¾‘ä¸ªäººä¿¡æ¯')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor('#2c2c2c')
          .width('100%')
          .padding({top:30})

      }
      .width('100%')
      .padding({
        left: 20,
        right: 20,
        top: 15,
        bottom: 15
      })
      .backgroundColor('#E7D1BB')

      Scroll() {
        Column() {
          // ç”¨æˆ·åè¾“å…¥
          Row() {
            Text('ç”¨æˆ·å:')
              .height(45)
            TextInput({ placeholder: 'è¯·å¡«å†™ç”¨æˆ·å', text: this.userInfo.username })
              .width('75%')
              .height(45)
              .margin({ left: 10 })
              .padding(10)
              .backgroundColor('#F5F5F5')
              .borderRadius(8)
              .onChange((value: string) => {
                this.userInfo.username = value; // æ­£ç¡®ç»‘å®šç”¨æˆ·å
              })
          }
          .margin({ top: 5 })
          .padding(5)

          // æ‰‹æœºå·è¾“å…¥
          Row() {
            Text('æ‰‹æœºå·:')
              .height(45)
            TextInput({ placeholder: 'è¯·å¡«å†™æ‰‹æœºå·', text: this.userInfo.avatar_url })
              .width('75%')
              .height(45)
              .margin({ left: 10 })
              .padding(10)
              .backgroundColor('#F5F5F5')
              .borderRadius(8)
              .onChange((value: string) => {
                this.userInfo.avatar_url = value; // æ­£ç¡®ç»‘å®šæ‰‹æœºå·
              })
          }
          .padding(5)
          .margin({ top: 15 })

          // å¯†ç è¾“å…¥
          Row() {
            Text('å¯†ç :')
              .height(45)
            TextInput({ placeholder: 'è¯·å¡«å†™å¯†ç ', text: this.userInfo.password })
              .width('75%')
              .height(45)
              .margin({ left: 10 })
              .padding(10)
              .backgroundColor('#F5F5F5')
              .borderRadius(8)
              .onChange((value: string) => {
                this.userInfo.password = value;
              })
          }
          .margin({ top: 5 })
          .padding(5)
        }
        .padding({ left: 15, right: 15 })
      }
      .margin({ top: 50 })
      .width('90%')
      .height('50%')
      .align(Alignment.Center)
      .padding(15)
      .backgroundColor('#ede4d3')
      .borderRadius(12)
      .layoutWeight(1)

      Column() {

      }
      .width('100%')
      .margin({ bottom: 30 })

      // åº•éƒ¨æŒ‰é’®
      Column() {
        Row() {
          Button('å–æ¶ˆ', { type: ButtonType.Capsule })
            .width('45%')
            .height(40)
            .backgroundColor('#F5F5F5')
            .fontColor('#333')
            .onClick(() => this.controller.close())
          Button('ç¡®å®š', { type: ButtonType.Capsule })
            .width('45%')
            .height(40)
            .backgroundColor('#F5F5F5')
            .fontColor('#333')
            .onClick(() => {
              this.onConfirm(this.userInfo);
              this.controller.close();
            })

        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceBetween)
        .margin({ bottom: 30 })

        Row() {
          Button('é€€å‡ºç™»å½•', { type: ButtonType.Capsule })
            .width('100%')
            .height(40)
            .backgroundColor($r('app.color.Orange'))
            .fontColor('#FFFFFF')
            .onClick(() => {
              this.pathStack.pushPathByName("Login", null, false)
              GlobalStorage.getInstance().phone = '';
              this.controller.close()

            }
            )
        }
        .width('70%')
      }
      .width('80%')
      .height('30%')
    }
    .backgroundColor('#F7EEDD')
    .borderRadius(16)
  }
}

@Builder
export function personalBuilder(userType: string) {
  personal({ userType: userType })
}

@Component
struct personal {
  @State deliveryList: DeliveryOrder[] = []
  userType: string = ''
  @State pathStack: NavPathStack = AppStorageV2.connect(NavPathStack, "navStack", () => new NavPathStack())!

  async aboutToAppear() {
    await MyRdb.getInstance().initRdbStore(getContext(this));
    this.loadDeliveryOrders()
  }

  @State userInfo: UserInfoWithPassword = {
    user_id: 0,
    username: 'Rshgdasx',
    phone: '',
    password: '',
    avatar_url: '19133384921',
    campus_id: 0,
    balance: 0
  };
  private myRdb = MyRdb.getInstance();
  // ç¼–è¾‘å¯¹è¯æ¡†æ§åˆ¶å™¨
  private dialogController: CustomDialogController = new CustomDialogController({
    builder: UserEditDialog({
      userInfo: this.userInfo,
      onConfirm: (user: UserInfoWithPassword) => {
        this.updateUserInfo(user);
      }
    }),
    customStyle: true,
    alignment: DialogAlignment.Center
  });


  build() {
    NavDestination() {
      Column({ space: 16 }) {
        Row({ space: 12 }) {
          // å·¦ä¾§å†…å®¹
          Row({ space: 12 }) {
            // å¤´åƒ
            Stack() {
              Image($r('app.media.personal'))
                .width(48)
                .height(48)
                .borderRadius(24)
            }
            .width(48)
            .height(48)
            .borderRadius(24)

            // å§“åä¸èŒä½ï¼Œä»æ•°æ®åº“è·å–
            Column({ space: 2 }) {
              Text(this.userInfo.username)
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .fontColor('#333333')
              Text('æ‰‹æœºå·ï¼š' + this.userInfo.avatar_url)
                .fontSize(14)
                .fontColor('#666666')
            }
            .alignItems(HorizontalAlign.Start)
          }
          .flexGrow(1)

          // ç¼–è¾‘
          Image($r('app.media.edit'))
            .width(24)
            .height(24)
            .onClick(() => {
              // this.pathStack.pushPathByName("Login", null, false)
              this.dialogController.open(); // æ‰“å¼€ç¼–è¾‘å¯¹è¯æ¡†
              // æ‰“å¼€ä¿®æ”¹ä¸ªäººä¿¡æ¯é¡µé¢ï¼Œå’Œå•†å“ä¸€æ ·
            })
        }
        .width('100%')

        // ç»Ÿè®¡æ¦‚è§ˆï¼šTotal Hoursã€Daily Streakã€Friends
        this.buildSummaryStats()

        // å½“å‰è®¢å•
        this.buildRecent()

        // å†å²è®¢å•
        this.buildHistory()

      }
      .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])
      .width('100%')
      .padding(16)
      .backgroundColor('#F5EFE0')
      .height('100%')
    }
    .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])
    .onReady(async (context: NavDestinationContext) => {
      const result = await MyRdb.getInstance().queryUserByPhone(
        getContext(this),
        GlobalStorage.getInstance().phone
      ) as UserInfoWithPassword | null;

      if (result) {
        // å®‰å…¨è®¿é—® - result å·²è¢«æ”¶çª„ä¸º UserInfoWithPassword
        this.userInfo = result;

      }
    })
  }


  // ç»Ÿè®¡æ¦‚è§ˆï¼šæ€»è®¢å•æ•°ï¼Œæœ¬æœˆè®¢å•æ•°ï¼Œæ€»æ¶ˆè´¹é‡‘é¢
  @Builder
  buildSummaryStats() {
    Row() {
      Row({ space: 5 }) {
        Image($r('app.media.fork2'))
          .fillColor($r('app.color.Charcoal_Gray'))
          .width(30)
          .height(30)

        Column({ space: 2 }) {
          Text('æœ¬æœˆè®¢å•')
            .fontSize(13)
            .fontWeight(FontWeight.Bold)
            .fontColor($r('app.color.Charcoal_Gray'))
          Text(this.deliveryList.length.toString())
            .fontSize(13)
            .fontColor($r('app.color.Charcoal_Gray'))
        }
        .alignItems(HorizontalAlign.Start)

      }
      .width('28%')
      .margin({ left: 20 })

      Divider()
        .vertical(true)
        .height(50)
        .color($r('app.color.Charcoal_Gray'))
        .opacity(0.5)
        .margin({ right: 10 })
        .strokeWidth(1.2)
        .border({ radius: 12 })

      Row({ space: 5 }) {
        Image($r('app.media.register'))
          .fillColor($r('app.color.Charcoal_Gray'))
          .width(30)
          .height(30)

        Column({ space: 2 }) {
          Text('æ€»è®¢å•')
            .fontSize(13)
            .fontWeight(FontWeight.Bold)
            .fontColor($r('app.color.Charcoal_Gray'))
          Text(this.deliveryList.length.toString())
            .fontSize(13)
            .fontColor($r('app.color.Charcoal_Gray'))
        }
        .margin({ right: 3 })
        .alignItems(HorizontalAlign.Start)

      }
      .width('30%')

      Divider()
        .vertical(true)
        .height(50)
        .color($r('app.color.Charcoal_Gray'))
        .opacity(0.5)
        .margin({ right: 10 })
        .strokeWidth(1.2)
        .border({ radius: 12 })

      Row({ space: 5 }) {
        Image($r('app.media.money'))
          .fillColor($r('app.color.Charcoal_Gray'))
          .width(30)
          .height(30)

        // åŠ å…¥åˆ¤å®šï¼Œå¦‚æœæ˜¯ç”¨æˆ·æ˜¾ç¤ºæ¶ˆè´¹é‡‘é¢ï¼Œå¦‚æœæ˜¯å•†å®¶æ˜¾ç¤ºæ”¶ç›Šï¼Œå¦‚æœæ˜¯æ£‹æ‰‹æ˜¾ç¤ºä½£é‡‘ï¼ˆè®¢å•é‡‘é¢4%ï¼‰
        Column({ space: 2 }) {
          if (this.userType === 'user') {
            Text('æ¶ˆè´¹é‡‘é¢')
              .fontSize(13)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.Charcoal_Gray'))
            Text(this.getTotalAmount().toFixed(0))
              .fontSize(13)
              .fontColor($r('app.color.Charcoal_Gray'))
          } else if (this.userType === 'merchant') {
            Text('æ”¶ç›Š')
              .fontSize(13)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.Charcoal_Gray'))
            Text(this.getTotalAmountMerchant().toFixed(0))
              .fontSize(13)
              .fontColor($r('app.color.Charcoal_Gray'))
          } else {
            Text('ä½£é‡‘')
              .fontSize(13)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.Charcoal_Gray'))
            Text(this.getTotalAmountDelivery().toFixed(0))
              .fontSize(13)
              .fontColor($r('app.color.Charcoal_Gray'))
          }

        }
        .alignItems(HorizontalAlign.Start)

      }
      .width('32%')
    }
    .height(90)
    .width('100%')
    .justifyContent(FlexAlign.Start)
    .margin({ top: 5, bottom: 5 })
    .backgroundColor($r('app.color.Orange'))
    .border({ radius: 10 })
  }

  // å½“å‰è®¢å•
  @Builder
  buildRecent() {
    Column({ space: 15 }) {
      Text('å½“å‰è®¢å•')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor($r('app.color.Charcoal_Gray'))
        .alignSelf(ItemAlign.Start)

      if (this.deliveryList.length > 0) {
        List() {
          if (this.deliveryList.length > 0) {
            ListItem() {
              this.DeliveryItem(this.deliveryList[this.deliveryList.length - 1])
            }
          }
        }
        .height(220)
        .scrollBar(BarState.Off)
        .edgeEffect(EdgeEffect.Spring)
      } else {
        Row() {
          Text('æš‚æ— å½“å‰è®¢å•')
            .fontSize(14)
            .fontColor('#999999')
            .textAlign(TextAlign.Center)
        }
        .backgroundColor(Color.White)
        .height(100)
        .width('100%')
        .justifyContent(FlexAlign.Center)
        .border({ radius: 12 })
      }
    }
  }

  // å†å²è®¢å•
  @Builder
  buildHistory() {
    Column({ space: 12 }) {
      Text('å†å²è®¢å•')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .alignSelf(ItemAlign.Start)

      if (this.deliveryList.length > 1) {
        List() {
          ForEach(
            this.changeStatusHistory(this.deliveryList.slice(0, -1).reverse()), // æˆªå–å¹¶å€’åº
            (item: DeliveryOrder) => {
              ListItem() {
                this.DeliveryItem(item)
              }
            }
          )
        }
        .height('40%')
        .scrollBar(BarState.Off)
        .edgeEffect(EdgeEffect.Spring)
      } else {
        Row() {
          Text('æš‚æ— å†å²è®¢å•')
            .fontSize(14)
            .fontColor('#999999')
            .textAlign(TextAlign.Center)
        }
        .backgroundColor(Color.White)
        .height(100)
        .width('100%')
        .justifyContent(FlexAlign.Center)
        .border({ radius: 12 })
      }
    }
  }

  private changeStatusHistory(orders: DeliveryOrder[]): DeliveryOrder[] {
    orders.forEach(order => {
      order.status = 'å·²å®Œæˆ'; // ç›´æ¥ä¿®æ”¹åŸå¯¹è±¡çš„çŠ¶æ€
    });
    return orders; // è¿”å›ä¿®æ”¹åçš„åŸæ•°ç»„
  }

  // è®¢å•çŠ¶æ€ç›¸å…³æ–¹æ³•
  private getStatusText(): string {
    switch (this.userType) {
      case 'user':
        return 'é…é€ä¸­'
      case 'merchant':
        return 'é…é€ä¸­'
      case 'delivery':
        return 'å¾…å–é¤'
      default:
        return 'æœªçŸ¥çŠ¶æ€'
    }
  }

  private getStatusColor(status: string): string {
    switch (status) {
      case 'å¾…å–é¤':
        return '#FF6B35'
      case 'é…é€ä¸­':
        return '#4CAF50'
      case 'å·²å®Œæˆ':
        return '#9E9E9E'
      default:
        return '#FF6B35'
    }
  }

  // è®¡ç®—æ€»æ¶ˆè´¹é‡‘é¢
  private getTotalAmount(): number {
    return this.deliveryList.reduce((total, order) => total + order.totalPrice, 0)
  }

  private getTotalAmountMerchant(): number {
    return this.getTotalAmount() * 0.8
  }

  private getTotalAmountDelivery(): number {
    return this.getTotalAmount() * 0.05
  }

  // è®¢å•é¡¹ç»„ä»¶ - ä½¿ç”¨hometakeoutçš„æ ·å¼
  @Builder
  DeliveryItem(item: DeliveryOrder) {
    Column() {
      // è®¢å•çŠ¶æ€æ å’Œç¼–å·
      Row() {
        Row() {
          Text(item.status)
            .fontSize(12)
            .fontColor('#FFFFFF')
            .fontWeight(FontWeight.Medium)
        }
        .height(24)
        .padding({ left: 8, right: 8 })
        .backgroundColor(this.getStatusColor(item.status))
        .borderRadius(12)
        .justifyContent(FlexAlign.Center)

        Blank()

        Text(`è®¢å•ç¼–å·ï¼š${item.orderCode}`)
          .fontSize(13)
          .fontColor('#666666')
      }
      .width('100%')
      .margin({ bottom: 12 })

      // ä¸»è¦å†…å®¹åŒºåŸŸ
      Row() {
        // å•†å“å›¾ç‰‡
        Image(MyData.getShopIconByName(item.shopName))
          .width(60)
          .height(60)
          .borderRadius(8)
          .backgroundColor('#F0F0F0')

        // è®¢å•ä¿¡æ¯
        Column() {
          // å•†å®¶ä¿¡æ¯
          Row() {
            Image($r('app.media.app_icon'))
              .width(16)
              .height(16)
              .fillColor('#FF6B35')
            Text(item.shopName)
              .fontSize(16)
              .fontColor('#333333')
              .fontWeight(FontWeight.Medium)
              .margin({ left: 4 })
          }
          .width('100%')
          .margin({ bottom: 8 })

          // å•†å“ä¿¡æ¯é¢„è§ˆ
          Column() {
            ForEach(item.foodList.slice(0, 2), (food: FoodItem, index: number) => {
              Row() {
                Text(food.name)
                  .fontSize(14)
                  .fontColor('#666666')
                  .layoutWeight(1)
                Text(`x${food.count}`)
                  .fontSize(14)
                  .fontColor('#666666')
                  .margin({ left: 8 })
              }
              .width('100%')
              .margin({ bottom: index === 0 ? 4 : 0 })
            })

            if (item.foodList.length > 2) {
              Text(`...ç­‰${item.foodList.length}ç§å•†å“`)
                .fontSize(12)
                .fontColor('#999999')
                .width('100%')
                .margin({ top: 4 })
            }
          }
          .alignItems(HorizontalAlign.Start)
          .margin({ bottom: 8 })

          // æ—¶é—´ä¿¡æ¯
          Text(`ä¸‹å•æ—¶é—´ï¼š${item.dateAdded}`)
            .fontSize(12)
            .fontColor('#999999')
            .width('100%')
        }
        .layoutWeight(1)
        .margin({ left: 12 })
        .alignItems(HorizontalAlign.Start)
      }
      .width('100%')
      .alignItems(VerticalAlign.Top)

      // åº•éƒ¨ä»·æ ¼åŒºåŸŸ
      Row() {
        Column() {
          Text(`ï¿¥${item.totalPrice.toFixed(2)}`)
            .fontSize(18)
            .fontColor('#FF6B35')
            .fontWeight(FontWeight.Bold)
          Text('è®¢å•é‡‘é¢')
            .fontSize(12)
            .fontColor('#999999')
            .margin({ top: 2 })
        }
        .alignItems(HorizontalAlign.Start)

        Blank()

        if (item.status === 'é…é€ä¸­') {
          Row() {
            Circle({ width: 8, height: 8 })
              .fill('#4CAF50')
              .margin({ right: 6 })
            Text('é…é€ä¸­')
              .fontSize(14)
              .fontColor('#4CAF50')
              .fontWeight(FontWeight.Medium)
          }
        } else if (item.status === 'å·²å®Œæˆ') {
          Text('å·²å®Œæˆ')
            .fontSize(14)
            .fontColor('#9E9E9E')
            .fontWeight(FontWeight.Medium)
        } else {
          Text('å¾…å–é¤')
            .fontSize(14)
            .fontColor('#FF6B35')
            .fontWeight(FontWeight.Medium)
        }
      }
      .width('100%')
      .margin({ top: 12 })
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
    .shadow({
      radius: 8,
      color: '#1A000000',
      offsetX: 0,
      offsetY: 2
    })
    .margin({ bottom: 10 })
    .onClick(() => {
      this.showOrderDetail(item)
    })
  }

  // æ˜¾ç¤ºè®¢å•è¯¦æƒ…
  private showOrderDetail(order: DeliveryOrder) {
    AlertDialog.show({
      title: 'è®¢å•è¯¦æƒ…',
      message: this.buildOrderDetailMessage(order),
      alignment: DialogAlignment.Center,
      primaryButton: {
        value: 'ç¡®å®š',
        fontColor: '#FFFFFF',
        backgroundColor: '#FF6B35',
        action: () => {
          console.info('å…³é—­è®¢å•è¯¦æƒ…')
        }
      },
      secondaryButton: {
        value: 'å–æ¶ˆ',
        fontColor: '#666666',
        backgroundColor: '#F5F5F5',
        action: () => {
          console.info('å–æ¶ˆè®¢å•è¯¦æƒ…')
        }
      }
    })
  }

  // æ„å»ºè®¢å•è¯¦æƒ…æ¶ˆæ¯
  private buildOrderDetailMessage(order: DeliveryOrder): string {
    let message = `ğŸ“‹ è®¢å•ç¼–å·ï¼š${order.orderCode}\n`
    message += `ğŸ“ è®¢å•çŠ¶æ€ï¼š${order.status}\n`
    message += `ğŸª å•†å®¶åç§°ï¼š${order.shopName}\n`
    message += `â° ä¸‹å•æ—¶é—´ï¼š${order.dateAdded}\n`
    message += `ğŸ“ é…é€åœ°å€ï¼š${order.address}\n`
    message += `ğŸ“ è”ç³»ç”µè¯ï¼š${order.phone}\n`
    message += `ğŸ’° è®¢å•é‡‘é¢ï¼šï¿¥${order.totalPrice}\n`
    message += '\nğŸ½ï¸ å•†å“æ¸…å•ï¼š\n'

    order.foodList.forEach((item, index) => {
      message += `${index + 1}. ${item.name} x${item.count} ï¿¥${(item.price * item.count).toFixed(2)}\n`
    })

    return message
  }

  // åŠ è½½é…é€è®¢å•
  async loadDeliveryOrders() {
    try {
      // 1. æŸ¥è¯¢æ‰€æœ‰è®¢å•
      const orders: OrderBean[] = await DbUtil.queryOrderList()

      // 2. ä¸ºæ¯ä¸ªè®¢å•è·å–è¯¦ç»†ä¿¡æ¯
      this.deliveryList = await Promise.all(
        orders.map(async (order: OrderBean) => {
          const deliveryOrder = new DeliveryOrder();

          // åŸºç¡€è®¢å•ä¿¡æ¯
          deliveryOrder.orderCode = order.order_code;
          deliveryOrder.status = this.getStatusText();
          deliveryOrder.shopName = order.shop_name;
          deliveryOrder.imgId = order.img_id;
          deliveryOrder.dateAdded = order.date_added;
          deliveryOrder.totalPrice = order.total_price;
          deliveryOrder.orderId = order.id;

          // 3. æ ¹æ®è®¢å•ä¸­çš„ goods_ids æŸ¥è¯¢èœå“è¯¦æƒ…
          try {
            if (order.goods_ids) {
              const goodsIds = this.parseGoodsIds(order.goods_ids);

              // 1. ä½¿ç”¨Mapç»Ÿè®¡æ¯ä¸ªå•†å“IDçš„å‡ºç°æ¬¡æ•°
              const idCountMap = new Map<string, number>();
              goodsIds.forEach(id => {
                idCountMap.set(id, (idCountMap.get(id) || 0) + 1);
              });

              // 2. è·å–å”¯ä¸€IDåˆ—è¡¨
              const uniqueIds = Array.from(idCountMap.keys());

              // 3. æ‰¹é‡æŸ¥è¯¢å•†å“ä¿¡æ¯ï¼ˆä¿æŒåŸæœ‰çš„ä¸²è¡ŒæŸ¥è¯¢æ–¹å¼ï¼Œé¿å…å¹¶è¡Œå‹åŠ›ï¼‰
              const foodList: FoodItem[] = [];
              for (const id of uniqueIds) {
                const food = await MyRdb.getInstance().getFoodById(getContext(this), id);
                if (food) {
                  foodList.push({
                    name: food.name,
                    count: idCountMap.get(id) || 1, // ä½¿ç”¨ç»Ÿè®¡çš„æ•°é‡
                    price: food.price
                  });
                }
              }

              deliveryOrder.foodList = foodList;
            } else {
              deliveryOrder.foodList = [];
            }
          } catch (error) {
            console.error('æŸ¥è¯¢èœå“è¯¦æƒ…å¤±è´¥:', error);
            deliveryOrder.foodList = [];
          }

          // 4. è®¾ç½®é…é€åœ°å€å’Œç”µè¯
          deliveryOrder.address = 'å­¦æºè¡—ä¸­å›½è®¡é‡å¤§å­¦258å·';
          deliveryOrder.phone = '15906635646';

          return deliveryOrder;
        })
      );

      // åˆ†ç¦»å½“å‰è®¢å•å’Œå†å²è®¢å•


      console.log('ä¸ªäººé¡µé¢è®¢å•åŠ è½½å®Œæˆ:', this.deliveryList);
    } catch (error) {
      console.error('åŠ è½½è®¢å•å¤±è´¥', error.message);
      this.deliveryList = [];

    }
  }

  // è¾…åŠ©æ–¹æ³•ï¼šè§£æå•†å“IDå­—ç¬¦ä¸²
  private parseGoodsIds(goodsIds: string): string[] {
    try {
      if (goodsIds.startsWith('[') || goodsIds.startsWith('{')) {
        return JSON.parse(goodsIds);
      } else if (goodsIds.includes(',')) {
        return goodsIds.split(',').map(id => id.trim());
      } else {
        return [goodsIds];
      }
    } catch (error) {
      console.error('è§£æå•†å“IDå¤±è´¥:', error);
      return [];
    }
  }

  //ç”¨æˆ·ä¿¡æ¯åŠ è½½ä¸æ›´æ–°
  private async loadUserInfo() {
    try {
      const user = await this.myRdb.queryUserByPhone(getContext(this), this.userInfo.phone);
      if (user) {
        this.userInfo = user; // æ›´æ–°æœ¬åœ°ç”¨æˆ·ä¿¡æ¯
      }
    } catch (e) {
      console.error("åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:", e);
    }
  }

  // æ›´æ–°ç”¨æˆ·ä¿¡æ¯åˆ°æ•°æ®åº“
  private async updateUserInfo(user: UserInfoWithPassword) {
    try {
      await this.myRdb.updateUser(getContext(this), user);
      this.userInfo = user; // åŒæ­¥æ›´æ–°æœ¬åœ°çŠ¶æ€
      this.showToast('æ›´æ–°æˆåŠŸ');
    } catch (e) {
      console.error("æ›´æ–°ç”¨æˆ·ä¿¡æ¯å¤±è´¥:", e);
      this.showToast('æ›´æ–°å¤±è´¥');
    }
  }

  // æ˜¾ç¤ºæç¤ºä¿¡æ¯
  private showToast(message: string) {
    this.getUIContext().getPromptAction().showToast({
      message,
      duration: 2000
    });
  }
}